<!DOCTYPE html>
<html>
<head>
    <title>HTM REPORT</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">

    <link rel="stylesheet" type="text/css" href="/static/layer/theme/default/layui.css">
    <link rel="stylesheet" type="text/css" href="/static/layer/theme/default/layer.css">
    <link rel="stylesheet" type="text/css" href="/static/layer/theme/default/global.css">

    <script type="text/javascript" src="/static/js/jquery.min.js"></script>
    <script type="text/javascript" src="/static/layer/layer.js"></script>
    <script type="text/javascript" src="/static/layer/layui.js"></script>
</head>
<body>
<div class="layui-header header header-docs">
    <div class="layui-main">
        <ul class="layui-nav">
            <li class="layui-nav-item ">
                <a href="">其它页</a>
            </li>
            <li class="layui-nav-item layui-this">
                <a href="javascript:;">报表区</a>
            </li>

            <span class="layui-nav-bar"></span></ul>
    </div>
</div>

<div class="layui-container" style="width: 99%">
    <div class="layui-panel site-menu" style="width: 18%; display: inline-block">
        <ul class="layui-menu layui-menu-lg site-docs-menu">
            <li class="layui-menu-item-group" lay-options="{type: 'group', isAllowSpread: true}">
                <div class="layui-menu-body-title"> 菜单区</div>
                <hr>
                <ul>
                    <li class="layui-menu-item-checked2">
                        <div class="layui-menu-body-title">
                            <a href="/temperature/list">
                                <span>数据上传</span>
                                <span class="layui-font-12 layui-font-gray">Temperature Uploader</span>
                            </a>
                        </div>
                    </li>
                    <li>
                        <div class="layui-menu-body-title">
                            <a href="/temperature/view">
                                <span>芯片温度 </span>
                                <span class="layui-font-12 layui-font-gray">HTM</span>
                            </a>
                        </div>
                    </li>
                </ul>
            </li>
        </ul>
    </div>
    <div class="site-content" style="width: 80%; display: inline-block">
        <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
            <legend>芯片数据上传</legend>
        </fieldset>

        <div class="layui-upload">
            <button type="button" class="layui-btn layui-btn-normal" id="testList">选择多文件</button>
            <div class="layui-upload-list">
                <table class="layui-table">
                    <colgroup>
                        <col>
                        <col style="width:150px;">
                        <col style="width:260px;">
                        <col style="width:150px;">
                    </colgroup>
                    <thead>
                    <tr>
                        <th>文件名</th>
                        <th>大小</th>
                        <th>上传进度</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="demoList">
                    {% for file in measurement_file_list %}
                        <tr>
                            <td>{{ file.file_name }}</td>
                            <td>--</td>
                            <td>--</td>
                            <td>
                                <button class="layui-btn layui-btn-xs layui-btn-danger demo-delete_db"
                                        onclick="delete_file_in_db({{ file.id }})">删除
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="button" class="layui-btn" id="testListAction">开始上传</button>
        </div>
    </div>
</div>
</body>
<script type="text/javascript">
    layui.use(['upload', 'element', 'layer'], function () {
        var $ = layui.jquery
            , upload = layui.upload
            , element = layui.element
            , layer = layui.layer;

        // 初始化上传实例
        var uploadListIns = upload.render({
            elem: '#testList',
            elemList: $('#demoList'), // 列表元素对象
            url: '/temperature/upload', // 实际使用时改成您自己的上传接口即可。
            accept: 'file',
            exts: 'mf4|dat',
            multiple: true,
            number: 3,
            auto: false,
            bindAction: '#testListAction',
            data: {
                test_team: "HTM",
                test_scenario: "",
                test_area: ""
            },
            choose: function (obj) {
                var that = this;
                this.files = obj.pushFile(); // 将每次选择的文件追加到文件队列

                // 预览文件并创建表格行
                obj.preview(function (index, file, result) {
                    addTableRow(file, index, that);
                });
            },
            before: function (obj) { //obj参数包含的信息，跟 choose回调完全一致
                layer.load(0, {shade: false}); //上传loading
            },

            done: function (res, index, upload) {
                var that = this;
                var tr = that.elemList.find(`tr#upload-${index}`);
                tr.find('td:last-child').empty(); // 清空操作列
                delete this.files[index]; // 删除已上传的文件

                if (res.upload_success) {
                    ret_data = {
                        "test_team": "HTM",
                        "test_scenario": "",
                        "test_area": "",
                        "measure_file_path": res.save_path
                    }
                    data_into_db(ret_data, index);
                }
            },
            allDone: function () {

            },
            error: function (index, upload) {
                var that = this;
                var tr = that.elemList.find(`tr#upload-${index}`);
                tr.find('td:last-child .demo-reload').removeClass('layui-hide'); // 显示重传按钮
                layer.closeAll('loading'); //关闭loading
                delete this.files[index]; // 删除已上传的文件
            },
            progress: function (n, elem, e, index) {
                element.progress(`progress-demo-${index}`, `${n}%`); // 更新进度条
            }
        });

        // 添加表格行
        function addTableRow(file, index, that) {
            var tr = $(`<tr id="upload-${index}">
            <td>${file.name}</td>
            <td>${(file.size / 1024).toFixed(1)}kb</td>
            <td>
                <div class="layui-progress" lay-filter="progress-demo-${index}">
                    <div class="layui-progress-bar"></div>
                </div>
            </td>
            <td>
                <button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>
                <button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>
            </td>
        </tr>`);

            // 绑定重传事件
            tr.find('.demo-reload').on('click', function () {
                uploadListIns.upload(index, file);
            });

            // 绑定删除事件
            tr.find('.demo-delete').on('click', function () {
                delete that.files[index];
                tr.remove();
                that.elemList.next()[0].value = ''; // 清空 input file 值
            });

            that.elemList.append(tr);
            element.render('progress'); // 渲染进度条组件
        }

        // 测量文件数据入库
        function data_into_db(ret_data, index) {
            fetch('/temperature/intodb', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(ret_data)
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    if (data.generate_report_failed.length === 0) {
                        layer.alert("上传成功", {icon: 6});
                        layer.closeAll('loading'); //关闭loading
                    } else {
                        layer.alert(data.generate_report_failed, {icon: 5});
                        layer.closeAll('loading'); //关闭loading
                    }
                })
                .catch(error => {
                    layer.alert(`请求失败: ${error}`, {icon: 5});
                    layer.closeAll('loading'); //关闭loading
                });
        }
    });

    function delete_file_in_db(fileId) {
        // 确认删除
        if (confirm("确定要删除该文件吗？")) {
            // 显示加载提示
            var loadingIndex = layer.load(0, {shade: false});

            // 发送 AJAX 请求删除文件
            fetch('/temperature/delete_file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({id: fileId})
            })
                .then(response => response.json())
                .then(data => {
                    // 关闭加载提示
                    layer.close(loadingIndex);

                    if (data.success) {
                        alert('文件删除成功！');
                        // 刷新页面或移除已删除的行
                        location.reload();
                    } else {
                        alert('文件删除失败：' + data.message);
                    }
                })
                .catch(error => {
                    // 关闭加载提示
                    layer.close(loadingIndex);
                    layer.alert('发生错误，请重试:', error);
                });
        }
    }
</script>
</html>